<!DOCTYPE html>
<html>

<head>
    <title>Chart.js Example</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        p {
            font-size: 18px;
            line-height: 1.5;
            color: #333;
        }

        h1 {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        #dropdown {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 200px;
            margin-bottom: 20px;
        }

        .checkbox-list {
            display: flex;
            flex-direction: row;
        }
    </style>
    <script>
        var chartObject;
        var applicationId = "AppName"
        var savedCpuSlowDownMultipliers = [];
        var savedResultTypes = [];
        $(document).ready(function () {
            populateSessionDropDownListData(applicationId);
            $('#dropdown').change(function () {
                var sessionId = $(this).val();
                setSessionChart(applicationId, sessionId);
            });

        });


        function populateSessionDropDownListData(applicationId) {
            // AJAX request to get dropdown data
            $.ajax({
                url: 'reports/' + applicationId + '/' + applicationId + '-sessionList.json',
                type: 'GET',
                success: function (data) {
                    // Populate dropdown with data
                    var dropdown = $('#dropdown');
                    //reset dropdown list 
                    dropdown.empty();
                    dropdown.append('<option selected="true" disabled>Choose Session</option>');
                    $.each(data.sessions, function (key, value) {
                        console.log(key + " " + JSON.stringify(value))
                        const ddOptionValue = value.sessionId;
                        const ddOptionKey = `${applicationId}-${value.sessionId}-${value.endDateTime}`
                        dropdown.append($('<option></option>').attr('value', ddOptionValue).text(ddOptionKey));
                    });
                },
                error: function (data) {
                    console.log("error: " + data)
                    alert("Error getting session list data");
                }
            });
        }

        function generateDataForChartOptions(data, savedCpuSlowDownMultipliers, resultTypes) {
            for (const [key, value] of Object.entries(data.cpuSlowDownMultiplierResultsList.interactiveResult)) {
                console.log(key + " " + JSON.stringify(value))
                savedCpuSlowDownMultipliers.push(key);
            }

            for (const [key, value] of Object.entries(data.cpuSlowDownMultiplierResultsList)) {
                console.log(key + " " + JSON.stringify(value))
                resultTypes.push(key);
            }
        }

        // Upon selection of drowdownlist value, call setSessionChart value
        function setSessionChart(applicationId, sessionId) {
            var colorList = ["red", "blue", "green", "orange", "purple", "yellow", "pink", "brown", "grey", "black"];
            var cpuSlowDownMultipliers = [];
            var resultTypes = [];


            fetch('reports/' + applicationId + '/chartdata/' + sessionId + '_cpuSlowDownMultiplierImpact.json')
                .then(response => response.json())
                .then(data => {
                    generateDataForChartOptions(data, savedCpuSlowDownMultipliers,resultTypes);
                    generateOptionsForChart(cpuSlowDownMultipliers, resultTypes);
                    
                    var dataSetValues = [];
                    //given data: data.cpuSlowDownMultiplierResultsList.interactiveResult, loop
                    //through each key and create a dataset object
                    var currentColorIndex = 0;
                    for (const [key, value] of Object.entries(data.cpuSlowDownMultiplierResultsList.interactiveResult)) {
                        var dataSet = {
                            label: "Interactive Result (" + key + "x CPU slowdown)",
                            data: value,
                            borderColor: colorList[currentColorIndex],
                            fill: false
                        }
                        dataSetValues.push(dataSet);
                        currentColorIndex++;
                    }
                    //given data: data.cpuSlowDownMultiplierResultsList.speedIndex, loop
                    //through each key and create a dataset object
                    //keep same color counters
                    for (const [key, value] of Object.entries(data.cpuSlowDownMultiplierResultsList.speedIndex)) {
                        var dataSet = {
                            label: "Speed Index (" + key + "x CPU slowdown)",
                            data: value,
                            borderColor: colorList[currentColorIndex],
                            fill: false
                        }
                        dataSetValues.push(dataSet);
                        currentColorIndex++;
                    }

                    const chartData = {
                        labels: data.networkSpeedList,
                        datasets: dataSetValues,
                    };
                    
                    const chartOptions = {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: "Performance Results - " + sessionId
                            }
                        },
                        scales: {

                            y: {
                                title: {
                                    display: true,
                                    text: "Time (ms)"
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: "Network Speed (kbps)"
                                }
                            }
                        }
                    };

                    const ctx = document.getElementById("myChart").getContext("2d");
                    //destroy chart if it already exists
                    if (typeof chartObject !== "undefined") {
                        chartObject.destroy();
                    }
                    chartObject = new Chart(ctx, {
                        type: "line",
                        data: chartData,
                        options: chartOptions
                    });
                });
        }
        function generateOptionsForChart(cpuSlowDownMultipliers, resultTypes) {
            // Create checkbox list for CPU Slow Down Multipliers
            // var cpuSlowDownMultipliers = [8, 4, 1, 0];
            // var cpuSlowDownMultipliersCheckboxList = "";
            for (var i = 0; i < cpuSlowDownMultipliers.length; i++) {
                cpuSlowDownMultipliersCheckboxList += '<input type="checkbox" class="cpuSlowDownMultiplierOptions" id="cpuSlowDownMultiplier' + cpuSlowDownMultipliers[i] + '" name="cpuSlowDownMultiplier" value="' + cpuSlowDownMultipliers[i] + '"';
                if (savedCpuSlowDownMultipliers.includes(cpuSlowDownMultipliers[i])) {
                    cpuSlowDownMultipliersCheckboxList += ' checked';
                }
                cpuSlowDownMultipliersCheckboxList += '>';
                cpuSlowDownMultipliersCheckboxList += '<label for="cpuSlowDownMultiplier' + cpuSlowDownMultipliers[i] + '"> ' + cpuSlowDownMultipliers[i] + 'x</label><br>';
            }
            document.getElementById("cpuSlowDownMultipliersCheckboxList").innerHTML = cpuSlowDownMultipliersCheckboxList;

            // Create checkbox list for type of values (Interactive and Speed Index)
            //var resultTypes = ["Interactive", "Speed Index"];
            var typeOfResultsCheckboxList = "";
            for (var i = 0; i < resultTypes.length; i++) {
                typeOfResultsCheckboxList += '<input type="checkbox" class= "resultTypeOptions" id="' + resultTypes[i] + '" name="typeOfValues" value="' + resultTypes[i] + '"';
                if (savedResultTypes.includes(resultTypes[i])) {
                    typeOfResultsCheckboxList += ' checked';
                }
                typeOfResultsCheckboxList += '>';
                typeOfResultsCheckboxList += '<label for="' + resultTypes[i] + '"> ' + resultTypes[i] + '</label><br>';
            }
            document.getElementById("typeOfValuesCheckboxList").innerHTML = typeOfResultsCheckboxList;
        }
    </script>
</head>

<body>
    <h1>Throttle Chart</h1>
    <p>This page displays a chart of performance results for different network speeds and CPU slowdowns. Select a
        session from the dropdown list to view its performance results.</p>
    <label for="dropdown">Select Session:</label>
    <select id="dropdown"></select>

    <h2>Graph Options</h2>
    <h3>CPU Slow Down Multipliers</h3>
    <div id="cpuSlowDownMultipliersCheckboxList" class="checkbox-list"></div>

    <h3>Type of Values</h3>
    <div id="typeOfValuesCheckboxList" class="checkbox-list"></div>
    <canvas id="myChart"></canvas>
</body>

</html>